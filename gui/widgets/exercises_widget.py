"""
PostureFix - Egzersizler Widget'ƒ±
Post√ºr d√ºzeltme egzersizlerini g√∂steren ve y√∂neten widget
"""
from PyQt5.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel,
    QFrame, QGridLayout, QPushButton, QScrollArea,
    QTextEdit, QProgressBar, QListWidget,
    QListWidgetItem, QTabWidget
)
from PyQt5.QtCore import Qt, pyqtSignal, QTimer
from PyQt5.QtGui import QFont, QPixmap, QIcon, QMovie

import logging
from datetime import datetime, timedelta
import json

from config import EXERCISE_CATEGORIES, COLORS

class ExercisesWidget(QWidget):
    """Egzersizler widget'ƒ±"""
    
    # Sinyaller
    exercise_started = pyqtSignal(str)  # egzersiz_id
    exercise_completed = pyqtSignal(str)  # egzersiz_id
    
    def __init__(self):
        super().__init__()
        
        self.logger = logging.getLogger(__name__)
        
        # Mevcut egzersiz durumu
        self.current_exercise = None
        self.exercise_timer = QTimer()
        self.exercise_timer.timeout.connect(self.update_exercise_progress)
        self.exercise_start_time = None
        self.exercise_duration = 0
        
        # Egzersiz verileri
        self.exercises_data = self.load_exercises_data()
        
        # UI kurulumu
        self.setup_ui()
        
        self.logger.info("ExercisesWidget olu≈üturuldu")
    
    def setup_ui(self):
        """UI kurulumu"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(10, 10, 10, 10)
        layout.setSpacing(10)
        
        # Ba≈ülƒ±k
        title = QLabel("üèÉ Post√ºr Egzersizleri")
        title.setFont(QFont("", 16, QFont.Bold))
        title.setAlignment(Qt.AlignCenter)
        layout.addWidget(title)
        
        # Tab widget
        self.tab_widget = QTabWidget()
        
        # √ñnerilen egzersizler sekmesi
        self.create_recommended_tab()
        self.tab_widget.addTab(self.recommended_widget, "√ñnerilen")
        
        # T√ºm egzersizler sekmesi
        self.create_all_exercises_tab()
        self.tab_widget.addTab(self.all_exercises_widget, "T√ºm Egzersizler")
        
        # Egzersiz ge√ßmi≈üi sekmesi
        self.create_history_tab()
        self.tab_widget.addTab(self.history_widget, "Ge√ßmi≈ü")
        
        layout.addWidget(self.tab_widget)
    
    def create_recommended_tab(self):
        """√ñnerilen egzersizler sekmesi"""
        self.recommended_widget = QWidget()
        layout = QVBoxLayout(self.recommended_widget)
        
        # Mevcut post√ºre g√∂re √∂neriler
        recommendations_frame = QFrame()
        recommendations_frame.setFrameStyle(QFrame.StyledPanel)
        
        rec_layout = QVBoxLayout(recommendations_frame)
        
        rec_title = QLabel("Post√ºr√ºn√ºze √ñzel √ñneriler")
        rec_title.setFont(QFont("", 14, QFont.Bold))
        rec_title.setAlignment(Qt.AlignCenter)
        rec_layout.addWidget(rec_title)
        
        # √ñnerilen egzersizler listesi
        self.recommended_list = QListWidget()
        self.populate_recommended_exercises()
        rec_layout.addWidget(self.recommended_list)
        
        layout.addWidget(recommendations_frame)
        
        # Hƒ±zlƒ± egzersiz butonu
        quick_exercise_btn = QPushButton("‚ö° 5 Dakikalƒ±k Hƒ±zlƒ± Egzersiz")
        quick_exercise_btn.setObjectName("primary_button")
        quick_exercise_btn.setFixedHeight(50)
        quick_exercise_btn.clicked.connect(self.start_quick_exercise)
        layout.addWidget(quick_exercise_btn)
        
        # Mevcut egzersiz paneli
        self.create_current_exercise_panel(layout)
    
    def create_all_exercises_tab(self):
        """T√ºm egzersizler sekmesi"""
        self.all_exercises_widget = QWidget()
        layout = QVBoxLayout(self.all_exercises_widget)
        
        # Kategori sekmesi
        self.category_tabs = QTabWidget()
        
        for category_key, category_name in EXERCISE_CATEGORIES.items():
            category_widget = self.create_category_widget(category_key)
            self.category_tabs.addTab(category_widget, category_name)
        
        layout.addWidget(self.category_tabs)
    
    def create_history_tab(self):
        """Egzersiz ge√ßmi≈üi sekmesi"""
        self.history_widget = QWidget()
        layout = QVBoxLayout(self.history_widget)
        
        # ƒ∞statistikler
        stats_frame = QFrame()
        stats_frame.setFrameStyle(QFrame.StyledPanel)
        stats_frame.setMaximumHeight(100)
        
        stats_layout = QHBoxLayout(stats_frame)
        
        # Bu hafta
        week_stats = self.create_stat_mini_card("Bu Hafta", "12", "egzersiz")
        stats_layout.addWidget(week_stats)
        
        # Bu ay
        month_stats = self.create_stat_mini_card("Bu Ay", "45", "egzersiz")
        stats_layout.addWidget(month_stats)
        
        # Toplam s√ºre
        time_stats = self.create_stat_mini_card("Toplam S√ºre", "3.2", "saat")
        stats_layout.addWidget(time_stats)
        
        layout.addWidget(stats_frame)
        
        # Ge√ßmi≈ü listesi
        history_list = QListWidget()
        self.populate_exercise_history(history_list)
        layout.addWidget(history_list)
    
    def create_category_widget(self, category_key: str):
        """Kategori widget'ƒ± olu≈ütur"""
        widget = QWidget()
        layout = QVBoxLayout(widget)
        
        # Kategori egzersizleri
        exercises = self.exercises_data.get(category_key, [])
        
        for exercise in exercises:
            exercise_card = self.create_exercise_card(exercise)
            layout.addWidget(exercise_card)
        
        layout.addStretch()
        
        # Scroll area
        scroll = QScrollArea()
        scroll.setWidget(widget)
        scroll.setWidgetResizable(True)
        
        return scroll
    
    def create_exercise_card(self, exercise_data: dict):
        """Egzersiz kartƒ± olu≈ütur"""
        card = QFrame()
        card.setFrameStyle(QFrame.StyledPanel)
        card.setMaximumHeight(150)
        
        layout = QHBoxLayout(card)
        layout.setContentsMargins(15, 10, 15, 10)
        
        # Sol taraf - bilgiler
        info_layout = QVBoxLayout()
        
        # Egzersiz adƒ±
        name_label = QLabel(exercise_data.get('name', 'Egzersiz'))
        name_label.setFont(QFont("", 14, QFont.Bold))
        info_layout.addWidget(name_label)
        
        # A√ßƒ±klama
        desc_label = QLabel(exercise_data.get('description', 'A√ßƒ±klama yok'))
        desc_label.setWordWrap(True)
        desc_label.setStyleSheet("color: gray;")
        info_layout.addWidget(desc_label)
        
        # S√ºre ve zorluk
        details_layout = QHBoxLayout()
        
        duration_label = QLabel(f"‚è±Ô∏è {exercise_data.get('duration', '5')} dk")
        duration_label.setStyleSheet("color: blue;")
        details_layout.addWidget(duration_label)
        
        difficulty = exercise_data.get('difficulty', 'Kolay')
        difficulty_color = {"Kolay": "green", "Orta": "orange", "Zor": "red"}.get(difficulty, "gray")
        difficulty_label = QLabel(f"üìä {difficulty}")
        difficulty_label.setStyleSheet(f"color: {difficulty_color};")
        details_layout.addWidget(difficulty_label)
        
        details_layout.addStretch()
        info_layout.addLayout(details_layout)
        
        layout.addLayout(info_layout)
        
        # Saƒü taraf - butonlar
        buttons_layout = QVBoxLayout()
        
        start_btn = QPushButton("Ba≈ülat")
        start_btn.setObjectName("primary_button")
        start_btn.clicked.connect(lambda: self.start_exercise(exercise_data))
        buttons_layout.addWidget(start_btn)
        
        info_btn = QPushButton("Detaylar")
        info_btn.setObjectName("secondary_button")
        info_btn.clicked.connect(lambda: self.show_exercise_details(exercise_data))
        buttons_layout.addWidget(info_btn)
        
        layout.addLayout(buttons_layout)
        
        return card
    
    def create_current_exercise_panel(self, parent_layout):
        """Mevcut egzersiz paneli"""
        self.current_exercise_frame = QFrame()
        self.current_exercise_frame.setFrameStyle(QFrame.StyledPanel)
        self.current_exercise_frame.setVisible(False)
        
        layout = QVBoxLayout(self.current_exercise_frame)
        
        # Ba≈ülƒ±k
        self.exercise_title = QLabel("Egzersiz Devam Ediyor")
        self.exercise_title.setFont(QFont("", 14, QFont.Bold))
        self.exercise_title.setAlignment(Qt.AlignCenter)
        layout.addWidget(self.exercise_title)
        
        # ƒ∞lerleme √ßubuƒüu
        self.exercise_progress = QProgressBar()
        self.exercise_progress.setRange(0, 100)
        layout.addWidget(self.exercise_progress)
        
        # S√ºre g√∂stergesi
        self.time_label = QLabel("00:00 / 05:00")
        self.time_label.setAlignment(Qt.AlignCenter)
        self.time_label.setFont(QFont("", 12))
        layout.addWidget(self.time_label)
        
        # Kontrol butonlarƒ±
        controls_layout = QHBoxLayout()
        
        self.pause_btn = QPushButton("Duraklat")
        self.pause_btn.clicked.connect(self.pause_exercise)
        controls_layout.addWidget(self.pause_btn)
        
        self.stop_btn = QPushButton("Durdur")
        self.stop_btn.clicked.connect(self.stop_exercise)
        controls_layout.addWidget(self.stop_btn)
        
        layout.addLayout(controls_layout)
        
        parent_layout.addWidget(self.current_exercise_frame)
    
    def create_stat_mini_card(self, title: str, value: str, unit: str):
        """Mini istatistik kartƒ±"""
        card = QFrame()
        card.setFrameStyle(QFrame.StyledPanel)
        card.setFixedSize(120, 80)
        
        layout = QVBoxLayout(card)
        layout.setContentsMargins(10, 5, 10, 5)
        
        title_label = QLabel(title)
        title_label.setFont(QFont("", 9))
        title_label.setAlignment(Qt.AlignCenter)
        title_label.setStyleSheet("color: gray;")
        layout.addWidget(title_label)
        
        value_label = QLabel(value)
        value_label.setFont(QFont("", 16, QFont.Bold))
        value_label.setAlignment(Qt.AlignCenter)
        layout.addWidget(value_label)
        
        unit_label = QLabel(unit)
        unit_label.setFont(QFont("", 8))
        unit_label.setAlignment(Qt.AlignCenter)
        unit_label.setStyleSheet("color: gray;")
        layout.addWidget(unit_label)
        
        return card
    
    def load_exercises_data(self):
        """Egzersiz verilerini y√ºkle"""
        # Demo egzersiz verileri
        return {
            "neck": [
                {
                    "id": "neck_1",
                    "name": "Boyun Germe",
                    "description": "Boyun kaslarƒ±nƒ± gev≈üetmek i√ßin yava≈ü boyun hareketleri",
                    "duration": "3",
                    "difficulty": "Kolay",
                    "instructions": [
                        "Ba≈üƒ±nƒ±zƒ± yava≈ü√ßa saƒüa √ßevirin",
                        "15 saniye bekleyin",
                        "Ba≈üƒ±nƒ±zƒ± yava≈ü√ßa sola √ßevirin",
                        "15 saniye bekleyin",
                        "Ba≈üƒ±nƒ±zƒ± √∂ne eƒüin",
                        "15 saniye bekleyin"
                    ]
                },
                {
                    "id": "neck_2",
                    "name": "Boyun Kuvvetlendirme",
                    "description": "Boyun kaslarƒ±nƒ± g√º√ßlendiren izometrik egzersizler",
                    "duration": "5",
                    "difficulty": "Orta",
                    "instructions": [
                        "Elinizi alnƒ±nƒ±za koyun",
                        "Ba≈üƒ±nƒ±zƒ± √∂ne itmeye √ßalƒ±≈üƒ±n",
                        "Elinizle kar≈üƒ± koyun",
                        "10 saniye tutun"
                    ]
                }
            ],
            "shoulder": [
                {
                    "id": "shoulder_1",
                    "name": "Omuz √áevirme",
                    "description": "Omuz kaslarƒ±nƒ± gev≈üeten dairesel hareketler",
                    "duration": "2",
                    "difficulty": "Kolay",
                    "instructions": [
                        "Omuzlarƒ±nƒ±zƒ± geriye doƒüru √ßevirin",
                        "10 tekrar yapƒ±n",
                        "Omuzlarƒ±nƒ±zƒ± √∂ne doƒüru √ßevirin",
                        "10 tekrar yapƒ±n"
                    ]
                }
            ],
            "back": [
                {
                    "id": "back_1",
                    "name": "Sƒ±rt Germe",
                    "description": "Sƒ±rt kaslarƒ±nƒ± uzatan ve g√º√ßlendiren hareketler",
                    "duration": "7",
                    "difficulty": "Orta",
                    "instructions": [
                        "Ayakta durun",
                        "Kollarƒ±nƒ±zƒ± yukarƒ± kaldƒ±rƒ±n",
                        "Geriye doƒüru hafif eƒüilin",
                        "15 saniye tutun"
                    ]
                }
            ],
            "general": [
                {
                    "id": "general_1",
                    "name": "Genel Post√ºr",
                    "description": "T√ºm v√ºcut post√ºr√ºn√º d√ºzelten kombine egzersizler",
                    "duration": "10",
                    "difficulty": "Orta",
                    "instructions": [
                        "Duvara sƒ±rtƒ±nƒ±zƒ± yaslayƒ±n",
                        "Ba≈üƒ±nƒ±zƒ±, omuzlarƒ±nƒ±zƒ± ve kal√ßanƒ±zƒ± duvara deƒüdirin",
                        "2 dakika bu pozisyonda kalƒ±n"
                    ]
                }
            ]
        }
    
    def populate_recommended_exercises(self):
        """√ñnerilen egzersizleri listele"""
        # ≈ûimdilik t√ºm kategorilerden birer egzersiz √∂ner
        recommended = [
            self.exercises_data["neck"][0],
            self.exercises_data["shoulder"][0],
            self.exercises_data["back"][0]
        ]
        
        self.recommended_list.clear()
        
        for exercise in recommended:
            item = QListWidgetItem()
            item.setText(f"{exercise['name']} ({exercise['duration']} dk)")
            item.setData(Qt.UserRole, exercise)
            self.recommended_list.addItem(item)
        
        # √áift tƒ±klama ile ba≈ülat
        self.recommended_list.itemDoubleClicked.connect(
            lambda item: self.start_exercise(item.data(Qt.UserRole))
        )
    
    def populate_exercise_history(self, history_list):
        """Egzersiz ge√ßmi≈üini doldur"""
        # Demo ge√ßmi≈ü verileri
        history_data = [
            {"date": "2024-01-15", "exercise": "Boyun Germe", "duration": "3 dk"},
            {"date": "2024-01-15", "exercise": "Omuz √áevirme", "duration": "2 dk"},
            {"date": "2024-01-14", "exercise": "Genel Post√ºr", "duration": "10 dk"},
            {"date": "2024-01-14", "exercise": "Boyun Kuvvetlendirme", "duration": "5 dk"},
            {"date": "2024-01-13", "exercise": "Sƒ±rt Germe", "duration": "7 dk"}
        ]
        
        for entry in history_data:
            item = QListWidgetItem()
            item.setText(f"{entry['date']} - {entry['exercise']} ({entry['duration']})")
            history_list.addItem(item)
    
    def start_exercise(self, exercise_data: dict):
        """Egzersiz ba≈ülat"""
        try:
            self.current_exercise = exercise_data
            self.exercise_start_time = datetime.now()
            self.exercise_duration = int(exercise_data.get('duration', 5)) * 60  # saniye
            
            # UI g√ºncelle
            self.exercise_title.setText(f"üèÉ {exercise_data['name']}")
            self.current_exercise_frame.setVisible(True)
            self.exercise_progress.setValue(0)
            
            # Timer ba≈ülat
            self.exercise_timer.start(1000)  # Her saniye
            
            # Sinyal g√∂nder
            self.exercise_started.emit(exercise_data['id'])
            
            self.logger.info(f"Egzersiz ba≈ülatƒ±ldƒ±: {exercise_data['name']}")
            
        except Exception as e:
            self.logger.error(f"Egzersiz ba≈ülatma hatasƒ±: {str(e)}")
    
    def start_quick_exercise(self):
        """Hƒ±zlƒ± egzersiz ba≈ülat"""
        quick_exercise = {
            "id": "quick_5min",
            "name": "Hƒ±zlƒ± 5 Dakika",
            "description": "Boyun, omuz ve sƒ±rt egzersizlerinin karƒ±≈üƒ±mƒ±",
            "duration": "5",
            "difficulty": "Kolay"
        }
        self.start_exercise(quick_exercise)
    
    def update_exercise_progress(self):
        """Egzersiz ilerlemesini g√ºncelle"""
        if not self.current_exercise or not self.exercise_start_time:
            return
        
        # Ge√ßen s√ºre
        elapsed = (datetime.now() - self.exercise_start_time).total_seconds()
        progress = (elapsed / self.exercise_duration) * 100
        
        # Progress bar g√ºncelle
        self.exercise_progress.setValue(min(int(progress), 100))
        
        # S√ºre etiketi g√ºncelle
        elapsed_min = int(elapsed // 60)
        elapsed_sec = int(elapsed % 60)
        total_min = int(self.exercise_duration // 60)
        total_sec = int(self.exercise_duration % 60)
        
        self.time_label.setText(f"{elapsed_min:02d}:{elapsed_sec:02d} / {total_min:02d}:{total_sec:02d}")
        
        # Egzersiz tamamlandƒ± mƒ±?
        if elapsed >= self.exercise_duration:
            self.complete_exercise()
    
    def pause_exercise(self):
        """Egzersizi duraklat"""
        if self.exercise_timer.isActive():
            self.exercise_timer.stop()
            self.pause_btn.setText("Devam Et")
        else:
            self.exercise_timer.start(1000)
            self.pause_btn.setText("Duraklat")
    
    def stop_exercise(self):
        """Egzersizi durdur"""
        self.exercise_timer.stop()
        self.current_exercise_frame.setVisible(False)
        self.current_exercise = None
        self.pause_btn.setText("Duraklat")
        
        self.logger.info("Egzersiz durduruldu")
    
    def complete_exercise(self):
        """Egzersizi tamamla"""
        if self.current_exercise:
            # Sinyal g√∂nder
            self.exercise_completed.emit(self.current_exercise['id'])
            
            # UI g√ºncelle
            self.exercise_title.setText("‚úÖ Egzersiz Tamamlandƒ±!")
            self.exercise_progress.setValue(100)
            
            self.logger.info(f"Egzersiz tamamlandƒ±: {self.current_exercise['name']}")
            
            # 3 saniye sonra paneli gizle
            QTimer.singleShot(3000, self.stop_exercise)
    
    def show_exercise_details(self, exercise_data: dict):
        """Egzersiz detaylarƒ±nƒ± g√∂ster"""
        # Basit mesaj kutusu (ger√ßek implementasyonda detaylƒ± dialog)
        from PyQt5.QtWidgets import QMessageBox
        
        details = f"""
Egzersiz: {exercise_data['name']}

A√ßƒ±klama: {exercise_data['description']}

S√ºre: {exercise_data['duration']} dakika
Zorluk: {exercise_data['difficulty']}

Talimatlar:
"""
        for i, instruction in enumerate(exercise_data.get('instructions', []), 1):
            details += f"{i}. {instruction}\n"
        
        msg = QMessageBox()
        msg.setWindowTitle("Egzersiz Detaylarƒ±")
        msg.setText(details)
        msg.exec_()
    
    def apply_theme(self, theme_name: str):
        """Tema uygula"""
        if theme_name == "dark":
            # Koyu tema stilleri
            card_style = """
                QFrame {
                    background-color: #2b2b2b;
                    border: 1px solid #555;
                    border-radius: 8px;
                    color: white;
                }
                QLabel {
                    color: white;
                }
            """
        else:
            # A√ßƒ±k tema stilleri
            card_style = """
                QFrame {
                    background-color: #ffffff;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    color: black;
                }
                QLabel {
                    color: black;
                }
            """
        
        # T√ºm frame'lere stil uygula
        for widget in self.findChildren(QFrame):
            widget.setStyleSheet(card_style)
